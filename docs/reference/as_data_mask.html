<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Create a data mask — as_data_mask • rlang</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>
  
  
<meta property="og:title" content="Create a data mask — as_data_mask" />

<meta property="og:description" content="A data mask is an environment (or possibly multiple environments
forming an ancestry) containing user-supplied objects. Objects in
the mask have precedence over objects in the environment (i.e. they
mask those objects). Many R functions evaluate quoted expressions
in a data mask so these expressions can refer to objects within the
user data.
These functions let you construct a tidy eval data mask manually.
They are meant for developers of tidy eval interfaces rather than
for end users. Most of the time you can just call eval_tidy()
with user data and the data mask will be constructed automatically.
There are three main use cases for manual creation of data masks:
When eval_tidy() is called with the same data in a tight loop.
Tidy eval data masks are a bit expensive to build so it is best
to construct it once and reuse it the other times for optimal
performance.
When several expressions should be evaluated in the same
environment because a quoted expression might create new objects
that can be referred in other quoted expressions evaluated at a
later time.
When your data mask requires special features. For instance the
data frame columns in dplyr data masks are implemented with
active bindings.
" />
<meta name="twitter:card" content="summary" />
<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">rlang</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../reference/lifecycle.html">Lifecycle</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/r-lib/rlang">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create a data mask</h1>
    </div>

    
    <p>A data mask is an environment (or possibly multiple environments
forming an ancestry) containing user-supplied objects. Objects in
the mask have precedence over objects in the environment (i.e. they
mask those objects). Many R functions evaluate quoted expressions
in a data mask so these expressions can refer to objects within the
user data.</p>
<p>These functions let you construct a tidy eval data mask manually.
They are meant for developers of tidy eval interfaces rather than
for end users. Most of the time you can just call <code><a href='eval_tidy.html'>eval_tidy()</a></code>
with user data and the data mask will be constructed automatically.
There are three main use cases for manual creation of data masks:</p><ul>
<li><p>When <code><a href='eval_tidy.html'>eval_tidy()</a></code> is called with the same data in a tight loop.
Tidy eval data masks are a bit expensive to build so it is best
to construct it once and reuse it the other times for optimal
performance.</p></li>
<li><p>When several expressions should be evaluated in the same
environment because a quoted expression might create new objects
that can be referred in other quoted expressions evaluated at a
later time.</p></li>
<li><p>When your data mask requires special features. For instance the
data frame columns in dplyr data masks are implemented with
<a href='http://www.rdocumentation.org/packages/base/topics/delayedAssign'>active bindings</a>.</p></li>
</ul>
    

    <pre class="usage"><span class='fu'>as_data_mask</span>(<span class='no'>data</span>, <span class='kw'>parent</span> <span class='kw'>=</span> <span class='fu'><a href='scoped_env.html'>base_env</a></span>())

<span class='fu'>as_data_pronoun</span>(<span class='no'>data</span>)

<span class='fu'>new_data_mask</span>(<span class='no'>bottom</span>, <span class='kw'>top</span> <span class='kw'>=</span> <span class='no'>bottom</span>, <span class='kw'>parent</span> <span class='kw'>=</span> <span class='fu'><a href='scoped_env.html'>base_env</a></span>())</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a> Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>data</th>
      <td><p>A data frame or named vector of masking data.</p></td>
    </tr>
    <tr>
      <th>parent</th>
      <td><p>The parent environment of the data mask.</p></td>
    </tr>
    <tr>
      <th>bottom</th>
      <td><p>The environment containing masking objects if the
data mask is one environment deep. The bottom environment if the
data mask comprises multiple environment.</p></td>
    </tr>
    <tr>
      <th>top</th>
      <td><p>The last environment of the data mask. If the data mask
is only one environment deep, <code>top</code> should be the same as
<code>bottom</code>.</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A data mask that you can supply to <code><a href='eval_tidy.html'>eval_tidy()</a></code>.</p>
    
    <h2 class="hasAnchor" id="building-your-own-data-mask"><a class="anchor" href="#building-your-own-data-mask"></a>Building your own data mask</h2>

    
    <p>Creating a data mask for <code><a href='http://www.rdocumentation.org/packages/base/topics/eval'>base::eval()</a></code> is a simple matter of
creating an environment containing masking objects that has the
user context as parent. <code>eval()</code> automates this task when you
supply data as second argument. However a tidy eval data mask also
needs to enable support of <a href='quotation.html'>quosures</a> and <a href='tidyeval-data.html'>data
pronouns</a>. These functions allow manual construction
of tidy eval data masks:</p><ul>
<li><p><code>as_data_mask()</code> transforms a data frame, named vector or
environment to a data mask. If an environment, its ancestry is
ignored. It automatically installs a data pronoun.</p></li>
<li><p><code>new_data_mask()</code> is a bare bones data mask constructor for
environments. You can supply a bottom and a top environment in
case your data mask comprises multiple environments.</p>
<p>Unlike <code>as_data_mask()</code> it does not install the <code>.data</code> pronoun
so you need to provide one yourself. You can provide a pronoun
constructed with <code>as_data_pronoun()</code> or your own pronoun class.</p></li>
</ul>
<ul>
<li><p><code>as_data_pronoun()</code> constructs a tidy eval data pronoun that
gives more useful error messages than regular data frames or
lists, i.e. when an object does not exist or if an user tries to
overwrite an object.</p></li>
</ul>
    <p>To use a a data mask, just supply it to <code><a href='eval_tidy.html'>eval_tidy()</a></code> as <code>data</code>
argument. You can repeat this as many times as needed. Note that
any objects created there (perhaps because of a call to <code>&lt;-</code>) will
persist in subsequent evaluations:</p>
    
    <h2 class="hasAnchor" id="life-cycle"><a class="anchor" href="#life-cycle"></a>Life cycle</h2>

    
    <p>All these functions are now stable.</p>
<p>In early versions of rlang data masks were called overscopes. We
think data mask is a more natural name in R. It makes reference to
masking in the search path which occurs through the same mechanism
(in technical terms, lexical scoping with hierarchically nested
environments). We say that that objects from user data mask objects
in the current environment.</p>
<p>Following this change in terminology, <code>as_data_mask()</code> and
<code><a href='as_overscope.html'>new_overscope()</a></code> were soft-deprecated in rlang 0.2.0 in favour of
<code>as_data_mask()</code> and <code>new_data_mask()</code>.</p>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># Evaluating in a tidy evaluation environment enables all tidy</span>
<span class='co'># features:</span>
<span class='no'>mask</span> <span class='kw'>&lt;-</span> <span class='fu'>as_data_mask</span>(<span class='no'>mtcars</span>)
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(<span class='fu'><a href='quotation.html'>quo</a></span>(<span class='no'>letters</span>), <span class='no'>mask</span>)</div><div class='output co'>#&gt;  [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
#&gt; [20] "t" "u" "v" "w" "x" "y" "z"</div><div class='input'>
<span class='co'># You can install new pronouns in the mask:</span>
<span class='no'>mask</span>$<span class='no'>.pronoun</span> <span class='kw'>&lt;-</span> <span class='fu'>as_data_pronoun</span>(<span class='fu'>list</span>(<span class='kw'>foo</span> <span class='kw'>=</span> <span class='st'>"bar"</span>, <span class='kw'>baz</span> <span class='kw'>=</span> <span class='st'>"bam"</span>))
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(<span class='fu'><a href='quotation.html'>quo</a></span>(<span class='no'>.pronoun</span>$<span class='no'>foo</span>), <span class='no'>mask</span>)</div><div class='output co'>#&gt; [1] "bar"</div><div class='input'>
<span class='co'># In some cases the data mask can leak to the user, for example if</span>
<span class='co'># a function or formula is created in the data mask environment:</span>
<span class='no'>cyl</span> <span class='kw'>&lt;-</span> <span class='st'>"user variable from the context"</span>
<span class='no'>fn</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(<span class='fu'>quote</span>(<span class='kw'>function</span>() <span class='no'>cyl</span>), <span class='no'>mask</span>)
<span class='fu'>fn</span>()</div><div class='output co'>#&gt;  [1] 6 6 4 6 8 6 8 4 4 6 6 8 8 8 8 8 8 4 4 4 4 8 8 8 8 4 4 4 8 6 8 4</div><div class='input'>
<span class='co'># If new objects are created in the mask, they persist in the</span>
<span class='co'># subsequent calls:</span>
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(<span class='fu'>quote</span>(<span class='no'>new</span> <span class='kw'>&lt;-</span> <span class='no'>cyl</span> + <span class='no'>am</span>), <span class='no'>mask</span>)</div><div class='output co'>#&gt;  [1] 7 7 5 6 8 6 8 4 4 6 6 8 8 8 8 8 8 5 5 5 4 8 8 8 8 5 5 5 9 7 9 5</div><div class='input'><span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(<span class='fu'>quote</span>(<span class='no'>new</span> * <span class='fl'>2</span>), <span class='no'>mask</span>)</div><div class='output co'>#&gt;  [1] 14 14 10 12 16 12 16  8  8 12 12 16 16 16 16 16 16 10 10 10  8 16 16 16 16
#&gt; [26] 10 10 10 18 14 18 10</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#building-your-own-data-mask">Building your own data mask</a></li>

      <li><a href="#life-cycle">Life cycle</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by Lionel Henry, <a href='http://hadley.nz'>Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
